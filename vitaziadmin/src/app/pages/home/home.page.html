<ion-header class="ion-no-border">
  <div class="fixed-header-container">
    <div class="header-banner">
      <div class="header-top"></div>
      <h1 class="page-title">Quản lý lịch khám</h1>
    </div>

    <div class="stats-container">
      <div class="stats-grid">
        <div class="stat-card purple">
          <div class="card-icon-row"><ion-icon name="person-outline"></ion-icon> <span>Tổng số</span></div>
          <div class="stat-value text-purple">{{ totalCount }}</div>
        </div>
        <div class="stat-card yellow">
          <div class="card-icon-row"><ion-icon name="time-outline"></ion-icon> <span>Chờ xử lý</span></div>
          <div class="stat-value text-yellow">{{ counts.PENDING || 0 }}</div>
        </div>
        <div class="stat-card green">
          <div class="card-icon-row"><ion-icon name="checkmark-circle-outline"></ion-icon> <span>Đã xác nhận</span></div>
          <div class="stat-value text-green">{{ counts.CONFIRMED || 0 }}</div>
        </div>
        <div class="stat-card red">
          <div class="card-icon-row"><ion-icon name="close-circle-outline"></ion-icon> <span>Đã hủy</span></div>
          <div class="stat-value text-red">{{ counts.CANCELED || 0 }}</div>
        </div>
      </div>
    </div>

    <div class="segment-section">
      <ion-segment [(ngModel)]="currentTab" (ionChange)="onTabChange()" mode="ios">
        <ion-segment-button value="PENDING"><ion-label>Chờ xử lý</ion-label></ion-segment-button>
        <ion-segment-button value="CONFIRMED"><ion-label>Đã xác nhận</ion-label></ion-segment-button>
        <ion-segment-button value="CANCELED"><ion-label>Đã hủy</ion-label></ion-segment-button>
      </ion-segment>
    </div>
  </div>
</ion-header>

<ion-content [fullscreen]="true" class="home-content">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content pullingIcon="chevron-down-circle-outline" refreshingSpinner="crescent"></ion-refresher-content>
  </ion-refresher>

  <div class="list-container">
    <ng-container *ngIf="isLoading && listData.length === 0">
      <div class="skeleton-card" *ngFor="let i of [1,2,3]">
        <div class="sk-header"><ion-skeleton-text animated class="sk-avatar"></ion-skeleton-text><div class="sk-info"><ion-skeleton-text animated style="width: 50%; height: 16px;"></ion-skeleton-text><ion-skeleton-text animated style="width: 80%; height: 12px; margin-top: 6px;"></ion-skeleton-text></div></div><div class="sk-footer"><ion-skeleton-text animated style="width: 100%; height: 30px;"></ion-skeleton-text></div>
      </div>
    </ng-container>

    <ng-container>
      <div class="blue-appointment-card fade-in" *ngFor="let item of listData" [class.expanded]="item.expanded">
        <div class="card-main" (click)="toggleExpand(item)">
          <img src="assets/img/clinic-dept-placeholder.jpg" class="dept-avatar" alt="dept" />
          <div class="info-col">
            <div class="title-row">
              <h3 class="dept-name">{{ item.departmentName || 'Phòng khám chung' }}</h3>
              <button class="icon-btn edit-btn" *ngIf="currentTab !== 'CANCELED'" (click)="$event.stopPropagation(); onEditClick(item)"><ion-icon name="create-outline"></ion-icon></button>
            </div>
            <div class="patient-name">Người đặt: <b>{{ item.userName }}</b></div>
            <div class="patient-phone" (click)="$event.stopPropagation(); onPhoneClick(item.userPhone)">SĐT: <span>{{ item.userPhone }}</span></div>
            <div class="appointment-time"><ion-icon name="calendar-outline"></ion-icon>{{ item.appointmentDate | date:'dd/MM/yyyy' }} <span class="time-badge">{{ formatTime(item.startTime) }}</span></div>
            <div class="inline-actions">
              <ng-container *ngIf="currentTab === 'PENDING'">
                <button class="btn-sm confirm" (click)="$event.stopPropagation(); updateStatus(item, 'CONFIRMED')">Xác nhận</button>
                <button class="btn-sm cancel" (click)="$event.stopPropagation(); updateStatus(item, 'CANCELED')">Hủy</button>
              </ng-container>
              <ng-container *ngIf="currentTab === 'CONFIRMED'">
                <button class="btn-sm cancel" (click)="$event.stopPropagation(); updateStatus(item, 'CANCELED')">Hủy lịch</button>
              </ng-container>
              <ng-container *ngIf="currentTab === 'CANCELED'">
                <button class="btn-sm confirm" (click)="$event.stopPropagation(); updateStatus(item, 'CONFIRMED')">Xác nhận</button>
              </ng-container>
            </div>
          </div>
          <div class="expand-indicator"><ion-icon [name]="item.expanded ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon></div>
        </div>
        <div class="expand-section" *ngIf="item.expanded">
          <div class="detail-row" *ngIf="item.description"><span class="label">Lý do:</span><span class="content">{{ item.description }}</span></div>
          <div class="detail-row" *ngIf="item.userEmail"><span class="label">Email:</span><span class="content">{{ item.userEmail }}</span></div>
        </div>
      </div>
    </ng-container>

    <div class="empty-state-styled" *ngIf="!isLoading && listData.length === 0">
      <div class="icon-circle"><ion-icon name="calendar-number-outline"></ion-icon></div>
      <h3>Chưa có lịch hẹn</h3>
      <p>Danh sách này hiện đang trống.</p>
    </div>

    <ion-infinite-scroll (ionInfinite)="onIonInfinite($event)" [disabled]="!hasMoreData">
      <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Đang tải thêm..."></ion-infinite-scroll-content>
    </ion-infinite-scroll>

    <div style="height: 40px;"></div>
  </div>
</ion-content>
